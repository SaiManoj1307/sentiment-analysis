<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniMind AI | Sentiment & Vision</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #ec4899;
            --bg-dark: #0b0f19;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            padding: 20px;
        }

        /* Navigation Tabs */
        .nav-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 0.5rem;
            border-radius: 100px;
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--glass-border);
        }

        .nav-tab {
            padding: 0.8rem 1.5rem;
            border-radius: 100px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .content-section {
            display: none;
            width: 100%;
            max-width: 1000px;
            animation: fadeIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        /* General Layout */
        .main-wrapper {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 2rem;
        }

        .full-width {
            grid-template-columns: 1fr;
        }

        @media (max-width: 900px) {
            .main-wrapper {
                grid-template-columns: 1fr;
            }
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        /*Text Analysis Styles*/
        textarea {
            width: 100%;
            height: 180px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            color: var(--text-main);
            font-size: 1.1rem;
            resize: none;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
        }

        /* Vision & Webcam Styles */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.01);
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--secondary);
            background: rgba(236, 72, 153, 0.05);
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        #imagePreview,
        #webcamResult {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 1.5rem;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
        }

        /* Buttons & Common */
        .btn {
            padding: 1rem 2rem;
            border-radius: 14px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            transition: all 0.2s;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            width: auto;
            margin-top: 0;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover,
        .btn-secondary:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s infinite linear;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Score Card */
        .score-card {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            margin-top: 1rem;
            display: none;
        }

        .score-large {
            font-size: 3rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin: 0.5rem 0;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .neutral {
            color: var(--warning);
        }

        /* Quick Chips (Text) */
        .quick-chips {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 100px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .chip:hover {
            border-color: var(--primary);
            color: white;
        }
    </style>
</head>

<body>

    <header style="text-align: center; margin-bottom: 1rem;">
        <h1
            style="font-size: 2.5rem; background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            OmniMind AI</h1>
        <p style="color: var(--text-muted)">Multimodal Artificial Intelligence Engine</p>
    </header>

    <div class="nav-container">
        <div class="nav-tab active" onclick="switchTab('text')"><i class="fa-solid fa-align-left"></i> Text Sentiment
        </div>
        <div class="nav-tab" onclick="switchTab('vision')"><i class="fa-solid fa-face-smile"></i> Face & Emotion</div>
    </div>

    <!-- TEXT SENTIMENT SECTION -->
    <div id="text-section" class="content-section active">
        <div class="main-wrapper">
            <div class="glass-card">
                <h2 style="margin-bottom: 1rem;">Review Analysis</h2>

                <div class="quick-chips">
                    <span class="chip"
                        onclick="fillText('I am so happy with this result! It makes me smile.')">Happy</span>
                    <span class="chip"
                        onclick="fillText('I am absolutely furious and angry about the delay!')">Angry</span>
                    <span class="chip" onclick="fillText('I feel so lonely and sad today.')">Sad</span>
                    <span class="chip" onclick="fillText('Wow, I really did not see that coming!')">Surprise</span>
                </div>

                <textarea id="reviewInput" placeholder="Enter text to analyze..."></textarea>

                <button class="btn btn-primary" onclick="analyzeText()" id="btnText">
                    <span>Analyze Sentiment</span>
                    <div class="loading"></div>
                </button>
            </div>

            <div class="glass-card" id="textControlArea">
                <h3 style="color: var(--text-muted); margin-bottom: 1rem;">Analysis Result</h3>
                <div id="textResultDefault" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                    <i class="fa-solid fa-chart-simple" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 1rem;">Waiting for input...</p>
                </div>

                <div id="textScoreCard" class="score-card">
                    <div id="textBadge" style="text-transform: uppercase; letter-spacing: 1px; font-weight: 600;"></div>
                    <div class="score-large" id="textScore"></div>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Model Confidence</p>
                </div>
            </div>
        </div>
    </div>

    <!-- VISION SECTION -->
    <div id="vision-section" class="content-section">
        <div class="glass-card full-width" style="align-items: center;">
            <h2 style="margin-bottom: 0.5rem;">Facial Expression Recognition</h2>
            <p style="margin-bottom: 2rem; color: var(--text-muted);">Analyze emotions from images or live webcam feed.
            </p>

            <!-- Toggle Controls -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="btn btn-ghost" onclick="setVisionMode('upload')" id="modeUploadBtn"
                    style="border: 1px solid var(--primary); color: var(--primary);">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Upload Image
                </button>
                <button class="btn btn-ghost" onclick="setVisionMode('webcam')" id="modeWebcamBtn">
                    <i class="fa-solid fa-video"></i> Use Webcam
                </button>
            </div>

            <!-- Upload Mode -->
            <div id="uploadModeArea" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleImageUpload(this)">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <h3>Click / Drag Image</h3>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem;">Supports JPG, PNG</p>
                </div>
                <img id="imagePreview" alt="Analyzed Result">
                <button class="btn btn-secondary" onclick="analyzeImage()" id="btnVision"
                    style="max-width: 300px; display: none;">
                    <span>Analyze Emotions</span>
                    <div class="loading"></div>
                </button>
            </div>

            <!-- Webcam Mode -->
            <div id="webcamModeArea" style="width: 100%; display: none; flex-direction: column; align-items: center;">
                <div
                    style="position: relative; border-radius: 16px; overflow: hidden; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <video id="webcamFeed" autoplay playsinline
                        style="width: 100%; max-width: 640px; display: block;"></video>
                    <canvas id="webcamCanvas" style="display: none;"></canvas> <!-- Hidden canvas for capture -->
                    <div id="webcamOverlay"
                        style="position: absolute; top: 10px; right: 10px; display:flex; gap: 0.5rem;">
                        <span
                            style="background: rgba(239, 68, 68, 0.8); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; display: none;"
                            id="liveIndicator">LIVE</span>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; width: 100%; justify-content: center;">
                    <button class="btn btn-primary" onclick="startCamera()" id="btnStartCam" style="max-width: 200px;">
                        <i class="fa-solid fa-power-off"></i> Start Camera
                    </button>
                    <button class="btn btn-secondary" onclick="captureAndAnalyze()" id="btnCapture"
                        style="max-width: 200px; display: none;">
                        <i class="fa-solid fa-camera"></i> Capture & Analyze
                    </button>
                </div>

                <!-- Result Area for Webcam -->
                <img id="webcamResult"
                    style="max-width: 640px; border-radius: 12px; margin-top: 1.5rem; display: none; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            </div>

        </div>
    </div>

    <script>
        let currentImageFile = null;
        let webcamStream = null;

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            if (tab === 'text') {
                document.querySelector('.nav-tab:first-child').classList.add('active');
                document.getElementById('text-section').classList.add('active');
                stopCamera(); // Ensure camera stops if leaving tab
            } else {
                document.querySelector('.nav-tab:last-child').classList.add('active');
                document.getElementById('vision-section').classList.add('active');
            }
        }

        function setVisionMode(mode) {
            const uploadBtn = document.getElementById('modeUploadBtn');
            const webcamBtn = document.getElementById('modeWebcamBtn');
            const uploadArea = document.getElementById('uploadModeArea');
            const webcamArea = document.getElementById('webcamModeArea');

            if (mode === 'upload') {
                uploadBtn.style.borderColor = 'var(--primary)';
                uploadBtn.style.color = 'var(--primary)';
                webcamBtn.style.borderColor = 'transparent';
                webcamBtn.style.color = 'var(--text-muted)';

                uploadArea.style.display = 'flex';
                webcamArea.style.display = 'none';
                stopCamera();
            } else {
                webcamBtn.style.borderColor = 'var(--primary)';
                webcamBtn.style.color = 'var(--primary)';
                uploadBtn.style.borderColor = 'transparent';
                uploadBtn.style.color = 'var(--text-muted)';

                webcamArea.style.display = 'flex';
                uploadArea.style.display = 'none';
            }
        }

        /* --- Text Logic --- */
        function fillText(text) {
            document.getElementById('reviewInput').value = text;
        }

        async function analyzeText() {
            const text = document.getElementById('reviewInput').value;
            if (!text) return;

            const btn = document.getElementById('btnText');
            setLoading(btn, true);

            try {
                const res = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ review: text })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('textResultDefault').style.display = 'none';
                    const card = document.getElementById('textScoreCard');
                    card.style.display = 'block';

                    const label = data.sentiment ? data.sentiment.toLowerCase() : 'neutral';
                    const scoreVal = document.getElementById('textScore');
                    const badge = document.getElementById('textBadge');

                    // Map emotions to UI states
                    let uiState = 'neutral';
                    if (['joy', 'happy', 'positive', 'love', 'optimism'].includes(label)) uiState = 'positive';
                    else if (['anger', 'sadness', 'fear', 'disgust', 'negative', 'sad', 'angry'].includes(label)) uiState = 'negative';

                    // Remove all possible classes first
                    scoreVal.classList.remove('positive', 'negative', 'neutral');
                    badge.classList.remove('positive', 'negative', 'neutral');

                    // Clear inline styles just in case
                    scoreVal.style.color = '';
                    badge.style.background = '';
                    badge.style.color = '';

                    // Add specific class
                    if (uiState === 'positive') {
                        scoreVal.classList.add('positive');
                        badge.classList.add('positive');
                    } else if (uiState === 'negative') {
                        scoreVal.classList.add('negative');
                        badge.classList.add('negative');
                    } else {
                        scoreVal.classList.add('neutral');
                        badge.classList.add('neutral');
                    }

                    scoreVal.innerText = (parseFloat(data.confidence) * 100).toFixed(1) + '%';
                    badge.innerText = label.toUpperCase();

                    // Provide Spotify suggestion
                    showSpotifyButton('textControlArea', data.spotify_link);
                }
            } catch (e) { console.error(e); alert('Error analyzing text'); }
            setLoading(btn, false);
        }

        /* --- Vision Logic (Upload) --- */
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                currentImageFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('btnVision').style.display = 'flex';
                    hideSpotifyButton();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function analyzeImage() {
            if (!currentImageFile) return;
            const btn = document.getElementById('btnVision');
            setLoading(btn, true);
            await performVisionAnalysis(currentImageFile, 'imagePreview', 'uploadModeArea');
            setLoading(btn, false);
        }

        /* --- Vision Logic (Webcam) --- */
        async function startCamera() {
            const video = document.getElementById('webcamFeed');
            const startBtn = document.getElementById('btnStartCam');
            const captureBtn = document.getElementById('btnCapture');
            const indicator = document.getElementById('liveIndicator');
            const resultImg = document.getElementById('webcamResult');

            resultImg.style.display = 'none'; // Hide previous result
            hideSpotifyButton();

            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = webcamStream;
                video.style.display = 'block';

                startBtn.style.display = 'none';
                captureBtn.style.display = 'flex';
                indicator.style.display = 'block';
            } catch (err) {
                alert("Could not access webcam. Please check permissions.");
                console.error(err);
            }
        }

        function stopCamera() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            const video = document.getElementById('webcamFeed');
            if (video) video.srcObject = null;

            const startBtn = document.getElementById('btnStartCam');
            if (startBtn) startBtn.style.display = 'flex';

            const captureBtn = document.getElementById('btnCapture');
            if (captureBtn) captureBtn.style.display = 'none';

            const indicator = document.getElementById('liveIndicator');
            if (indicator) indicator.style.display = 'none';
        }

        async function captureAndAnalyze() {
            const video = document.getElementById('webcamFeed');
            const canvas = document.getElementById('webcamCanvas');
            const captureBtn = document.getElementById('btnCapture');

            // Draw video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            setLoading(captureBtn, true);

            // Convert to blob and send
            canvas.toBlob(async (blob) => {
                if (blob) {
                    await performVisionAnalysis(blob, 'webcamResult', 'webcamModeArea');
                    document.getElementById('webcamResult').style.display = 'block';
                }
                setLoading(captureBtn, false);
            }, 'image/jpeg');
        }

        async function performVisionAnalysis(fileBlob, imgElementId, containerId) {
            const formData = new FormData();
            formData.append('image', fileBlob);

            try {
                const res = await fetch('/analyze_image', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    // Update image with the annotated base64 version
                    const img = document.getElementById(imgElementId);
                    img.src = 'data:image/jpeg;base64,' + data.image_b64;

                    // Show Spotify Button
                    if (data.spotify_link) {
                        showSpotifyButton(containerId, data.spotify_link, "Mood Playlist");
                    }
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            } catch (e) { alert('Server error during analysis'); }
        }

        function showSpotifyButton(containerId, link, text = "Listen on Spotify") {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Remove existing button if any
            let existing = container.querySelector('.spotify-btn');
            if (existing) existing.remove();

            const btn = document.createElement('a');
            btn.className = 'btn spotify-btn';
            btn.href = link;
            btn.target = '_blank';
            btn.innerHTML = `<i class="fa-brands fa-spotify" style="font-size: 1.2rem;"></i> ${text}`;
            btn.style.backgroundColor = '#1DB954';
            btn.style.color = 'white';
            btn.style.marginTop = '1rem';
            btn.style.textDecoration = 'none';
            btn.style.maxWidth = '250px';
            btn.style.boxShadow = '0 4px 15px rgba(29, 185, 84, 0.4)';

            container.appendChild(btn);
        }

        function hideSpotifyButton() {
            document.querySelectorAll('.spotify-btn').forEach(btn => btn.remove());
        }

        function setLoading(btn, isLoading) {
            if (!btn) return;
            const spinner = btn.querySelector('.loading');
            // If button has an icon, it might be an <i> tag or inside text
            const icon = btn.querySelector('i');

            btn.disabled = isLoading;
            if (spinner) {
                spinner.style.display = isLoading ? 'block' : 'none';
                if (icon) icon.style.display = isLoading ? 'none' : 'block';
            }
        }
    </script>

</body>

</html>